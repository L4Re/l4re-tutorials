inherit: [ l4re-dist ]

depends:
    - name: kernel::linux-image
      environment:
          LINUX_CUSTOM_CONFIG: "$(get-tool-env,target-toolchain,ARCH).defconfig"
          LINUX_CUSTOM_CONFIG_PKG: "examples::guests::linux-cfg"
    - examples::guests::linux-initramfs

privateEnvironment:
    TARGET_ARCH: "$(get-tool-env,target-toolchain,ARCH)"

buildVars: [TARGET_ARCH]
buildScript: |
    case $TARGET_ARCH in
        arm)
            DTB=virt-arm_virt-32.dtb
            KERNEL=zImage
            ;;
        arm64)
            DTB=virt-arm_virt-64.dtb
            KERNEL=Image.gz
            ;;
        riscv)
            DTB=virt-riscv64.dtb
            KERNEL=Image.gz
            ;;
        x86_64)
            DTB=virt-pc.dtb
            KERNEL=bzImage
            ;;
        *)
            echo "Example not yet adapted for architecture ${ARCH}!" >&2
            echo "Please choose an approriate guest device tree."
            exit 1
            ;;
    esac

multiPackage:
    single:
        buildScript: |
            cp $<<linux-vm/single.cfg>> single.cfg

            cat >modules.list <<EOF
            entry linux-vm
            kernel fiasco -serial_esc
            moe single.cfg
            module l4re
            module ned
            module uvmm
            module[fname=virt.dtb]        dtb/$DTB
            module[fname=linux,nostrip]   $KERNEL
            module[fname=ramdisk.cpio.gz] initramfs.cpio.gz
            EOF

            l4reBuildImages \
                ${BOB_DEP_PATHS[kernel::linux-image]} \
                ${BOB_DEP_PATHS[examples::guests::linux-initramfs]}

    multi:
        buildScript: |
            cp $<<linux-vm/multi.cfg>> multi.cfg

            cat >modules.list <<EOF
            entry linux-vm
            kernel fiasco -serial_esc
            moe multi.cfg
            module l4re
            module cons
            module ned
            module uvmm
            module l4vio_switch
            module[fname=virt.dtb]        dtb/$DTB
            module[fname=linux,nostrip]   $KERNEL
            module[fname=ramdisk.cpio.gz] initramfs.cpio.gz
            EOF

            l4reBuildImages \
                ${BOB_DEP_PATHS[kernel::linux-image]} \
                ${BOB_DEP_PATHS[examples::guests::linux-initramfs]}

packageScript: |
    l4reInstallImages
